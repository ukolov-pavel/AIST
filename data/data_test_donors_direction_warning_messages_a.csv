query, test_data_set_number
"select top(1) PerC.UniqueId Ent, 'Донор отведён (тип отвода: Абсолютный).' OR1 from PersonCards PerC join AppointedDonationTypes AppD on PerC.UniqueId = AppD.DonorId join (select AppD.DonorId, max(AppD.DonationDate) MaxDate from AppointedDonationTypes AppD group by AppD.DonorId) Main on AppD.DonorId = Main.DonorId and AppD.DonationDate = Main.MaxDate join ref.DonationTypeParams DonTP on AppD.DonationTypeId = DonTP.DonationTypeId join ref.DonationTypes DonT on AppD.DonationTypeId = DonT.UniqueId join Deferrals Def on PerC.UniqueId = Def.DonorId and Def.RevokeDate is null join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId and DefT.BaseType = 1 where PerC.IsDeleted != 1 and PerC.BirthDateIsUndefined = 0 and PerC.DeathDate is null and PerC.UniqueId not in (select PrReg.DonorId from DonationProcessRegistry PrReg where PrReg.RegDate = cast(getdate() as date) and PrReg.CurrentState != 6) and PerC.UniqueId not in (select Don.DonorId from Donations Don where cast(Don.DonationDate as date) = cast(getdate() as date)) and PerC.UniqueId not in (select Def.DonorId from Deferrals Def join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where ((DefT.BaseType = 2 and Def.RevokeDate is null) or (DefT.BaseType = 3 and (cast(Def.StopDate as date) >= cast(getdate() as date) or Def.StopDate is null)))) and PerC.Gender in (1,2) and PerC.IdentityDocId is not null and ((PerC.RegAddressId is not null and (PerC.RegAddressIsInactive = 0 or PerC.RegAddressIsInactive is null)) or (PerC.FactAddressId is not null and (PerC.FactAddressIsInactive = 0 or PerC.FactAddressIsInactive is null)) or (PerC.TempAddressId is not null and (PerC.TempAddressIsInactive = 0 or PerC.TempAddressIsInactive is null))) and DonTP.IsActive = 1 and DonT.DonationParams not in (4, 5, 6, 7, 12, 15) and (cast(AppD.NextDonationDate as date) <= cast(getdate() as date) or AppD.NextDonationDate is null) and DonT.ChargeType = 0 and PerC.UniqueId not in (select Don.DonorId from Donations Don where Don.ResultStatus != 5)",1
"select top(1) PerC.UniqueId Ent, 'Донор отведён (тип отвода: Абсолютный).' OR1 from PersonCards PerC join AppointedDonationTypes AppD on PerC.UniqueId = AppD.DonorId join (select AppD.DonorId, max(AppD.DonationDate) MaxDate from AppointedDonationTypes AppD group by AppD.DonorId) Main on AppD.DonorId = Main.DonorId and AppD.DonationDate = Main.MaxDate join ref.DonationTypeParams DonTP on AppD.DonationTypeId = DonTP.DonationTypeId join ref.DonationTypes DonT on AppD.DonationTypeId = DonT.UniqueId join Deferrals Def on PerC.UniqueId = Def.DonorId and Def.RevokeDate is null join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId and DefT.BaseType = 1 where PerC.IsDeleted != 1 and PerC.BirthDateIsUndefined = 0 and PerC.DeathDate is null and PerC.UniqueId not in (select PrReg.DonorId from DonationProcessRegistry PrReg where PrReg.RegDate = cast(getdate() as date) and PrReg.CurrentState != 6) and PerC.UniqueId not in (select Don.DonorId from Donations Don where cast(Don.DonationDate as date) = cast(getdate() as date)) and PerC.UniqueId not in (select Def.DonorId from Deferrals Def join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where ((DefT.BaseType = 2 and Def.RevokeDate is null) or (DefT.BaseType = 3 and (cast(Def.StopDate as date) >= cast(getdate() as date) or Def.StopDate is null)))) and PerC.UniqueId not in (select MaxDon.DonorId from Donations Don join (select Don.DonorId, max(Don.DonationDate) MaxDate from Donations Don, ref.SystemSettings SysSet where Don.OrgId = SysSet.CurrentOrganizationId group by Don.DonorId) MaxDon on Don.DonorId = MaxDon.DonorId and Don.DonationDate != MaxDon.MaxDate join DonationTestResults DonTest on Don.UniqueId = DonTest.DonationId where DonTest.TestTypeId = 42 and DonTest.TestValue = 13) and PerC.Gender in (1,2) and PerC.IdentityDocId is not null and ((PerC.RegAddressId is not null and (PerC.RegAddressIsInactive = 0 or PerC.RegAddressIsInactive is null)) or (PerC.FactAddressId is not null and (PerC.FactAddressIsInactive = 0 or PerC.FactAddressIsInactive is null)) or (PerC.TempAddressId is not null and (PerC.TempAddressIsInactive = 0 or PerC.TempAddressIsInactive is null))) and DonT.DonationParams not in (4, 5, 6, 7, 12, 15) and (cast(AppD.NextDonationDate as date) <= cast(getdate() as date) or AppD.NextDonationDate is null) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType = 2) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id 	and MedTT.ExamType in (3, 4) and MedTT.BloodTestCategory != 10) and DonT.ChargeType = 3 and PerC.UniqueId not in (select Don.DonorId from Donations Don where Don.ResultStatus != 5)",2
"select top(1) PerC.UniqueId Ent, 'Донор отведён (тип отвода: Контроль).' OR1 from PersonCards PerC join AppointedDonationTypes AppD on PerC.UniqueId = AppD.DonorId join (select AppD.DonorId, max(AppD.DonationDate) MaxDate from AppointedDonationTypes AppD group by AppD.DonorId) Main on AppD.DonorId = Main.DonorId and AppD.DonationDate = Main.MaxDate join ref.DonationTypeParams DonTP on AppD.DonationTypeId = DonTP.DonationTypeId join ref.DonationTypes DonT on AppD.DonationTypeId = DonT.UniqueId where PerC.IsDeleted != 1 and PerC.BirthDateIsUndefined = 0 and PerC.DeathDate is null and PerC.UniqueId in (select AppD.DonorId from AppointedDonationTypes AppD) and PerC.UniqueId not in (select PrReg.DonorId from DonationProcessRegistry PrReg where PrReg.RegDate = cast(getdate() as date)) and PerC.UniqueId not in (select Don.DonorId from Donations Don where cast(Don.DonationDate as date) = cast(getdate() as date)) and PerC.UniqueId not in (select PerC.UniqueId from PersonCards PerC join Deferrals Def on Perc.UniqueId = Def.DonorId join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where DefT.BaseType = 1 and Def.RevokeDate is null) and PerC.UniqueId not in (select MaxDon.DonorId from Donations Don join (select Don.DonorId, max(Don.DonationDate) MaxDate from Donations Don, ref.SystemSettings SysSet where Don.OrgId = SysSet.CurrentOrganizationId group by Don.DonorId) MaxDon on Don.DonorId = MaxDon.DonorId and Don.DonationDate = MaxDon.MaxDate join DonationTestResults DonTest on Don.UniqueId = DonTest.DonationId where DonTest.TestTypeId = 42 and DonTest.TestValue = 13) and PerC.Gender in (1,2) and PerC.IdentityDocId is not null and ((PerC.RegAddressId is not null and PerC.RegAddressIsInactive = 0) or (PerC.FactAddressId is not null and PerC.FactAddressIsInactive = 0) or (PerC.TempAddressId is not null and PerC.TempAddressIsInactive = 0)) and DonTP.IsActive = 1 and DonT.DonationParams not in (4, 5, 6, 7, 12, 15) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType = 2) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType in (3, 4) and MedTT.BloodTestCategory != 10) and DonT.ChargeType not in (0, 3) and PerC.UniqueId in (select PerC.UniqueId from PersonCards PerC join Deferrals Def on Perc.UniqueId = Def.DonorId join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where DefT.BaseType = 2 and Def.RevokeDate is null) and PerC.UniqueId not in (select PerC.UniqueId from PersonCards PerC join Deferrals Def on Perc.UniqueId = Def.DonorId join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where DefT.BaseType = 3 and Def.RevokeDate is null and cast(Def.StopDate as date) > cast(getdate() as date))",3
"select top(1) PerC.UniqueId Ent, 'Донор отведён (тип отвода: Временный).' OR1 from PersonCards PerC join AppointedDonationTypes AppD on PerC.UniqueId = AppD.DonorId join (select AppD.DonorId, max(AppD.DonationDate) MaxDate from AppointedDonationTypes AppD group by AppD.DonorId) Main on AppD.DonorId = Main.DonorId and AppD.DonationDate = Main.MaxDate join ref.DonationTypeParams DonTP on AppD.DonationTypeId = DonTP.DonationTypeId join ref.DonationTypes DonT on AppD.DonationTypeId = DonT.UniqueId where PerC.IsDeleted != 1 and PerC.BirthDateIsUndefined = 0 and PerC.DeathDate is null and PerC.UniqueId in (select AppD.DonorId from AppointedDonationTypes AppD) and PerC.UniqueId not in (select PrReg.DonorId from DonationProcessRegistry PrReg where PrReg.RegDate = cast(getdate() as date)) and PerC.UniqueId not in (select Don.DonorId from Donations Don where cast(Don.DonationDate as date) = cast(getdate() as date)) and PerC.UniqueId not in (select PerC.UniqueId from PersonCards PerC join Deferrals Def on Perc.UniqueId = Def.DonorId join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where DefT.BaseType = 1 and Def.RevokeDate is null) and PerC.UniqueId not in (select MaxDon.DonorId from Donations Don join (select Don.DonorId, max(Don.DonationDate) MaxDate from Donations Don, ref.SystemSettings SysSet where Don.OrgId = SysSet.CurrentOrganizationId group by Don.DonorId) MaxDon on Don.DonorId = MaxDon.DonorId and Don.DonationDate = MaxDon.MaxDate join DonationTestResults DonTest on Don.UniqueId = DonTest.DonationId where DonTest.TestTypeId = 42 and DonTest.TestValue = 13) and PerC.Gender in (1,2) and PerC.IdentityDocId is not null and ((PerC.RegAddressId is not null and PerC.RegAddressIsInactive = 0) or (PerC.FactAddressId is not null and PerC.FactAddressIsInactive = 0) or (PerC.TempAddressId is not null and PerC.TempAddressIsInactive = 0)) and DonTP.IsActive = 1 and DonT.DonationParams not in (4, 5, 6, 7, 12, 15) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType = 2) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType in (3, 4) and MedTT.BloodTestCategory != 10) and DonT.ChargeType not in (0, 3) and PerC.UniqueId not in (select PerC.UniqueId from PersonCards PerC join Deferrals Def on Perc.UniqueId = Def.DonorId join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where DefT.BaseType = 2 and Def.RevokeDate is null) and PerC.UniqueId in (select PerC.UniqueId from PersonCards PerC join Deferrals Def on Perc.UniqueId = Def.DonorId join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where DefT.BaseType = 3 and Def.RevokeDate is null and cast(Def.StopDate as date) > cast(getdate() as date))",4
"select top(1) PerC.UniqueId Ent, 'Нарушен интервал между донациями.' OR1 from PersonCards PerC join AppointedDonationTypes AppD on PerC.UniqueId = AppD.DonorId join (select AppD.DonorId, max(AppD.DonationDate) MaxDate from AppointedDonationTypes AppD group by AppD.DonorId) Main on AppD.DonorId = Main.DonorId and AppD.DonationDate = Main.MaxDate join ref.DonationTypeParams DonTP on AppD.DonationTypeId = DonTP.DonationTypeId join ref.DonationTypes DonT on AppD.DonationTypeId = DonT.UniqueId where PerC.IsDeleted != 1 and PerC.BirthDateIsUndefined = 0 and PerC.DeathDate is null and PerC.UniqueId in (select AppD.DonorId from AppointedDonationTypes AppD) and PerC.UniqueId not in (select PrReg.DonorId from DonationProcessRegistry PrReg where PrReg.RegDate = cast(getdate() as date)) and PerC.UniqueId not in (select Don.DonorId from Donations Don where cast(Don.DonationDate as date) = cast(getdate() as date)) and PerC.UniqueId not in (select PerC.UniqueId from PersonCards PerC join Deferrals Def on Perc.UniqueId = Def.DonorId join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where DefT.BaseType = 1 and Def.RevokeDate is null) and PerC.UniqueId not in (select MaxDon.DonorId from Donations Don join (select Don.DonorId, max(Don.DonationDate) MaxDate from Donations Don, ref.SystemSettings SysSet where Don.OrgId = SysSet.CurrentOrganizationId group by Don.DonorId) MaxDon on Don.DonorId = MaxDon.DonorId and Don.DonationDate = MaxDon.MaxDate join DonationTestResults DonTest on Don.UniqueId = DonTest.DonationId where DonTest.TestTypeId = 42 and DonTest.TestValue = 13) and PerC.Gender in (1,2) and PerC.IdentityDocId is not null and ((PerC.RegAddressId is not null and PerC.RegAddressIsInactive = 0) or (PerC.FactAddressId is not null and PerC.FactAddressIsInactive = 0) or (PerC.TempAddressId is not null and PerC.TempAddressIsInactive = 0)) and DonTP.IsActive = 1 and DonT.DonationParams not in (4, 5, 6, 7, 12, 15) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType = 2) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType in (3, 4) and MedTT.BloodTestCategory != 10) and DonT.ChargeType not in (0, 3) and cast(AppD.NextDonationDate as date) > cast(getdate() as date)",5
"select top(1) PerC.UniqueId Ent, 'Нарушено количество кроводач за год.' OR1 from ref.SystemSettings SysSet, PersonCards PerC join (select Don.DonorId, count(Don.UniqueId) Q from Donations Don join ref.DonationTypes DonT on Don.DonationTypeId = DonT.UniqueId where DonT.ComponentType = 1 and Don.IsDeleted = 0 and Don.UniqueId not in (select DonCom.DonationId from DonationComplications DonCom join ref.DonationComplicationTypes DonComT on DonCom.ComplicationTypeGuid = DonComT.Guid where DonComT.CalculateDonation = 0) and cast(Don.DonationDate as date) > dateadd(year, -1, cast(getdate() as date)) group by Don.DonorId) Com on PerC.UniqueId = Com.DonorId join AppointedDonationTypes AppD on PerC.UniqueId = AppD.DonorId join (select AppD.DonorId, max(AppD.DonationDate) MaxDate from AppointedDonationTypes AppD group by AppD.DonorId) Main on AppD.DonorId = Main.DonorId and AppD.DonationDate = Main.MaxDate join ref.DonationTypeParams DonTP on AppD.DonationTypeId = DonTP.DonationTypeId join ref.DonationTypes DonT on AppD.DonationTypeId = DonT.UniqueId where PerC.IsDeleted != 1 and Com.Q > SysSet.MaxYearBloodDonationCountFemale and PerC.BirthDateIsUndefined = 0 and PerC.DeathDate is null and PerC.UniqueId in (select AppD.DonorId from AppointedDonationTypes AppD) and PerC.UniqueId not in (select PrReg.DonorId from DonationProcessRegistry PrReg where PrReg.RegDate = cast(getdate() as date)) and PerC.UniqueId not in (select Don.DonorId from Donations Don where cast(Don.DonationDate as date) = cast(getdate() as date)) and PerC.UniqueId not in (select PerC.UniqueId from PersonCards PerC join Deferrals Def on Perc.UniqueId = Def.DonorId join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where DefT.BaseType = 1 and Def.RevokeDate is null) and PerC.UniqueId not in (select MaxDon.DonorId from Donations Don join (select Don.DonorId, max(Don.DonationDate) MaxDate from Donations Don, ref.SystemSettings SysSet where Don.OrgId = SysSet.CurrentOrganizationId group by Don.DonorId) MaxDon on Don.DonorId = MaxDon.DonorId and Don.DonationDate = MaxDon.MaxDate join DonationTestResults DonTest on Don.UniqueId = DonTest.DonationId where DonTest.TestTypeId = 42 and DonTest.TestValue = 13) and PerC.Gender = 2 and PerC.IdentityDocId is not null and ((PerC.RegAddressId is not null and PerC.RegAddressIsInactive = 0) or (PerC.FactAddressId is not null and PerC.FactAddressIsInactive = 0) or (PerC.TempAddressId is not null and PerC.TempAddressIsInactive = 0)) and DonTP.IsActive = 1 and DonT.DonationParams not in (4, 5, 6, 7, 12, 15) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType = 2) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType in (3, 4) and MedTT.BloodTestCategory != 10) and DonT.ChargeType not in (0, 3) and DonT.ComponentType = 1",6
"select top(1) PerC.UniqueId Ent, 'Нарушено количество кроводач за год.' OR1 from ref.SystemSettings SysSet, PersonCards PerC join (select Don.DonorId, count(Don.UniqueId) Q from Donations Don join ref.DonationTypes DonT on Don.DonationTypeId = DonT.UniqueId where DonT.ComponentType = 1 and Don.IsDeleted = 0 and Don.UniqueId not in (select DonCom.DonationId from DonationComplications DonCom join ref.DonationComplicationTypes DonComT on DonCom.ComplicationTypeGuid = DonComT.Guid where DonComT.CalculateDonation = 0) and cast(Don.DonationDate as date) > dateadd(year, -1, cast(getdate() as date)) group by Don.DonorId) Com on PerC.UniqueId = Com.DonorId join AppointedDonationTypes AppD on PerC.UniqueId = AppD.DonorId join (select AppD.DonorId, max(AppD.DonationDate) MaxDate from AppointedDonationTypes AppD group by AppD.DonorId) Main on AppD.DonorId = Main.DonorId and AppD.DonationDate = Main.MaxDate join ref.DonationTypeParams DonTP on AppD.DonationTypeId = DonTP.DonationTypeId join ref.DonationTypes DonT on AppD.DonationTypeId = DonT.UniqueId where PerC.IsDeleted != 1 and Com.Q = SysSet.MaxYearBloodDonationCountMale and PerC.BirthDateIsUndefined = 0 and PerC.DeathDate is null and PerC.UniqueId in (select AppD.DonorId from AppointedDonationTypes AppD) and PerC.UniqueId not in (select PrReg.DonorId from DonationProcessRegistry PrReg where PrReg.RegDate = cast(getdate() as date)) and PerC.UniqueId not in (select Don.DonorId from Donations Don where cast(Don.DonationDate as date) = cast(getdate() as date)) and PerC.UniqueId not in (select PerC.UniqueId from PersonCards PerC join Deferrals Def on Perc.UniqueId = Def.DonorId join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where DefT.BaseType = 1 and Def.RevokeDate is null) and PerC.UniqueId not in (select MaxDon.DonorId from Donations Don join (select Don.DonorId, max(Don.DonationDate) MaxDate from Donations Don, ref.SystemSettings SysSet where Don.OrgId = SysSet.CurrentOrganizationId group by Don.DonorId) MaxDon on Don.DonorId = MaxDon.DonorId and Don.DonationDate = MaxDon.MaxDate join DonationTestResults DonTest on Don.UniqueId = DonTest.DonationId where DonTest.TestTypeId = 42 and DonTest.TestValue = 13) and PerC.Gender = 1 and PerC.IdentityDocId is not null and ((PerC.RegAddressId is not null and PerC.RegAddressIsInactive = 0) or (PerC.FactAddressId is not null and PerC.FactAddressIsInactive = 0) or (PerC.TempAddressId is not null and PerC.TempAddressIsInactive = 0)) and DonTP.IsActive = 1 and DonT.DonationParams not in (4, 5, 6, 7, 12, 15) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType = 2) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType in (3, 4) and MedTT.BloodTestCategory != 10) and DonT.ChargeType not in (0, 3) and DonT.ComponentType = 1",7
"select top(1) PerC.UniqueId Ent, 'Нарушено количество плазмаферезов за год.' OR1 from ref.SystemSettings SysSet, PersonCards PerC join (select Don.DonorId, count(Don.UniqueId) Q from Donations Don join ref.DonationTypes DonT on Don.DonationTypeId = DonT.UniqueId where DonT.ComponentType = 2 and Don.IsDeleted = 0 and Don.UniqueId not in (select DonCom.DonationId from DonationComplications DonCom join ref.DonationComplicationTypes DonComT on DonCom.ComplicationTypeGuid = DonComT.Guid where DonComT.CalculateDonation = 0) and cast(Don.DonationDate as date) > dateadd(year, -1, cast(getdate() as date)) group by Don.DonorId) Com on PerC.UniqueId = Com.DonorId join AppointedDonationTypes AppD on PerC.UniqueId = AppD.DonorId join (select AppD.DonorId, max(AppD.DonationDate) MaxDate from AppointedDonationTypes AppD group by AppD.DonorId) Main on AppD.DonorId = Main.DonorId and AppD.DonationDate = Main.MaxDate join ref.DonationTypeParams DonTP on AppD.DonationTypeId = DonTP.DonationTypeId join ref.DonationTypes DonT on AppD.DonationTypeId = DonT.UniqueId where PerC.IsDeleted != 1 and Com.Q > SysSet.MaxYearPlasmapheresisCount and PerC.BirthDateIsUndefined = 0 and PerC.DeathDate is null and PerC.UniqueId in (select AppD.DonorId from AppointedDonationTypes AppD) and PerC.UniqueId not in (select PrReg.DonorId from DonationProcessRegistry PrReg where PrReg.RegDate = cast(getdate() as date)) and PerC.UniqueId not in (select Don.DonorId from Donations Don where cast(Don.DonationDate as date) = cast(getdate() as date)) and PerC.UniqueId not in (select PerC.UniqueId from PersonCards PerC join Deferrals Def on Perc.UniqueId = Def.DonorId join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where DefT.BaseType = 1 and Def.RevokeDate is null) and PerC.UniqueId not in (select MaxDon.DonorId from Donations Don join (select Don.DonorId, max(Don.DonationDate) MaxDate from Donations Don, ref.SystemSettings SysSet where Don.OrgId = SysSet.CurrentOrganizationId group by Don.DonorId) MaxDon on Don.DonorId = MaxDon.DonorId and Don.DonationDate = MaxDon.MaxDate join DonationTestResults DonTest on Don.UniqueId = DonTest.DonationId where DonTest.TestTypeId = 42 and DonTest.TestValue = 13) and PerC.Gender in (1, 2) and PerC.IdentityDocId is not null and ((PerC.RegAddressId is not null and PerC.RegAddressIsInactive = 0) or (PerC.FactAddressId is not null and PerC.FactAddressIsInactive = 0) or (PerC.TempAddressId is not null and PerC.TempAddressIsInactive = 0)) and DonTP.IsActive = 1 and DonT.DonationParams not in (4, 5, 6, 7, 12, 15) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType = 2) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType in (3, 4) and MedTT.BloodTestCategory != 10) and DonT.ChargeType not in (0, 3) and DonT.ComponentType = 2",8
"select top(1) PerC.UniqueId Ent, 'Нарушено количество плазмаферезов за год.' OR1 from ref.SystemSettings SysSet, PersonCards PerC join (select Don.DonorId, count(Don.UniqueId) Q from Donations Don join ref.DonationTypes DonT on Don.DonationTypeId = DonT.UniqueId where DonT.ComponentType = 2 and Don.IsDeleted = 0 and Don.UniqueId not in (select DonCom.DonationId from DonationComplications DonCom join ref.DonationComplicationTypes DonComT on DonCom.ComplicationTypeGuid = DonComT.Guid where DonComT.CalculateDonation = 0) and cast(Don.DonationDate as date) > dateadd(year, -1, cast(getdate() as date)) group by Don.DonorId) Com on PerC.UniqueId = Com.DonorId join AppointedDonationTypes AppD on PerC.UniqueId = AppD.DonorId join (select AppD.DonorId, max(AppD.DonationDate) MaxDate from AppointedDonationTypes AppD group by AppD.DonorId) Main on AppD.DonorId = Main.DonorId and AppD.DonationDate = Main.MaxDate join ref.DonationTypeParams DonTP on AppD.DonationTypeId = DonTP.DonationTypeId join ref.DonationTypes DonT on AppD.DonationTypeId = DonT.UniqueId where PerC.IsDeleted != 1 and Com.Q = SysSet.MaxYearPlasmapheresisCount and PerC.BirthDateIsUndefined = 0 and PerC.DeathDate is null and PerC.UniqueId in (select AppD.DonorId from AppointedDonationTypes AppD) and PerC.UniqueId not in (select PrReg.DonorId from DonationProcessRegistry PrReg where PrReg.RegDate = cast(getdate() as date)) and PerC.UniqueId not in (select Don.DonorId from Donations Don where cast(Don.DonationDate as date) = cast(getdate() as date)) and PerC.UniqueId not in (select PerC.UniqueId from PersonCards PerC join Deferrals Def on Perc.UniqueId = Def.DonorId join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where DefT.BaseType = 1 and Def.RevokeDate is null) and PerC.UniqueId not in (select MaxDon.DonorId from Donations Don join (select Don.DonorId, max(Don.DonationDate) MaxDate from Donations Don, ref.SystemSettings SysSet where Don.OrgId = SysSet.CurrentOrganizationId group by Don.DonorId) MaxDon on Don.DonorId = MaxDon.DonorId and Don.DonationDate = MaxDon.MaxDate join DonationTestResults DonTest on Don.UniqueId = DonTest.DonationId where DonTest.TestTypeId = 42 and DonTest.TestValue = 13) and PerC.Gender in (1, 2) and PerC.IdentityDocId is not null and ((PerC.RegAddressId is not null and PerC.RegAddressIsInactive = 0) or (PerC.FactAddressId is not null and PerC.FactAddressIsInactive = 0) or (PerC.TempAddressId is not null and PerC.TempAddressIsInactive = 0)) and DonTP.IsActive = 1 and DonT.DonationParams not in (4, 5, 6, 7, 12, 15) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType = 2) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType in (3, 4) and MedTT.BloodTestCategory != 10) and DonT.ChargeType not in (0, 3) and DonT.ComponentType = 2",9
"select top(1) PerC.UniqueId Ent, 'Нарушено количество цитаферезов за год.' OR1 from ref.SystemSettings SysSet, PersonCards PerC join (select Don.DonorId, count(Don.UniqueId) Q from Donations Don join ref.DonationTypes DonT on Don.DonationTypeId = DonT.UniqueId where DonT.ComponentType in (3, 4, 5) and Don.IsDeleted = 0 and Don.UniqueId not in (select DonCom.DonationId from DonationComplications DonCom join ref.DonationComplicationTypes DonComT on DonCom.ComplicationTypeGuid = DonComT.Guid where DonComT.CalculateDonation = 0) and cast(Don.DonationDate as date) > dateadd(year, -1, cast(getdate() as date)) group by Don.DonorId) Com on PerC.UniqueId = Com.DonorId join AppointedDonationTypes AppD on PerC.UniqueId = AppD.DonorId join (select AppD.DonorId, max(AppD.DonationDate) MaxDate from AppointedDonationTypes AppD group by AppD.DonorId) Main on AppD.DonorId = Main.DonorId and AppD.DonationDate = Main.MaxDate join ref.DonationTypeParams DonTP on AppD.DonationTypeId = DonTP.DonationTypeId join ref.DonationTypes DonT on AppD.DonationTypeId = DonT.UniqueId where PerC.IsDeleted != 1 and Com.Q > SysSet.MaxYearCytapheresisCount and PerC.BirthDateIsUndefined = 0 and PerC.DeathDate is null and PerC.UniqueId in (select AppD.DonorId from AppointedDonationTypes AppD) and PerC.UniqueId not in (select PrReg.DonorId from DonationProcessRegistry PrReg where PrReg.RegDate = cast(getdate() as date)) and PerC.UniqueId not in (select Don.DonorId from Donations Don where cast(Don.DonationDate as date) = cast(getdate() as date)) and PerC.UniqueId not in (select PerC.UniqueId from PersonCards PerC join Deferrals Def on Perc.UniqueId = Def.DonorId join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where DefT.BaseType = 1 and Def.RevokeDate is null) and PerC.UniqueId not in (select MaxDon.DonorId from Donations Don join (select Don.DonorId, max(Don.DonationDate) MaxDate from Donations Don, ref.SystemSettings SysSet where Don.OrgId = SysSet.CurrentOrganizationId group by Don.DonorId) MaxDon on Don.DonorId = MaxDon.DonorId and Don.DonationDate = MaxDon.MaxDate join DonationTestResults DonTest on Don.UniqueId = DonTest.DonationId where DonTest.TestTypeId = 42 and DonTest.TestValue = 13) and PerC.Gender in (1, 2) and PerC.IdentityDocId is not null and ((PerC.RegAddressId is not null and PerC.RegAddressIsInactive = 0) or (PerC.FactAddressId is not null and PerC.FactAddressIsInactive = 0) or (PerC.TempAddressId is not null and PerC.TempAddressIsInactive = 0)) and DonTP.IsActive = 1 and DonT.DonationParams not in (4, 5, 6, 7, 12, 15) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType = 2) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType in (3, 4) and MedTT.BloodTestCategory != 10) and DonT.ChargeType not in (0, 3) and DonT.ComponentType in (3, 4, 5)",10
"select top(1) PerC.UniqueId Ent, 'Нарушено количество цитаферезов за год.' OR1 from ref.SystemSettings SysSet, PersonCards PerC join (select Don.DonorId, count(Don.UniqueId) Q from Donations Don join ref.DonationTypes DonT on Don.DonationTypeId = DonT.UniqueId where DonT.ComponentType in (3, 4, 5) and Don.IsDeleted = 0 and Don.UniqueId not in (select DonCom.DonationId from DonationComplications DonCom join ref.DonationComplicationTypes DonComT on DonCom.ComplicationTypeGuid = DonComT.Guid where DonComT.CalculateDonation = 0) and cast(Don.DonationDate as date) > dateadd(year, -1, cast(getdate() as date)) group by Don.DonorId) Com on PerC.UniqueId = Com.DonorId join AppointedDonationTypes AppD on PerC.UniqueId = AppD.DonorId join (select AppD.DonorId, max(AppD.DonationDate) MaxDate from AppointedDonationTypes AppD group by AppD.DonorId) Main on AppD.DonorId = Main.DonorId and AppD.DonationDate = Main.MaxDate join ref.DonationTypeParams DonTP on AppD.DonationTypeId = DonTP.DonationTypeId join ref.DonationTypes DonT on AppD.DonationTypeId = DonT.UniqueId where PerC.IsDeleted != 1 and Com.Q = SysSet.MaxYearCytapheresisCount and PerC.BirthDateIsUndefined = 0 and PerC.DeathDate is null and PerC.UniqueId in (select AppD.DonorId from AppointedDonationTypes AppD) and PerC.UniqueId not in (select PrReg.DonorId from DonationProcessRegistry PrReg where PrReg.RegDate = cast(getdate() as date)) and PerC.UniqueId not in (select Don.DonorId from Donations Don where cast(Don.DonationDate as date) = cast(getdate() as date)) and PerC.UniqueId not in (select PerC.UniqueId from PersonCards PerC join Deferrals Def on Perc.UniqueId = Def.DonorId join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where DefT.BaseType = 1 and Def.RevokeDate is null) and PerC.UniqueId not in (select MaxDon.DonorId from Donations Don join (select Don.DonorId, max(Don.DonationDate) MaxDate from Donations Don, ref.SystemSettings SysSet where Don.OrgId = SysSet.CurrentOrganizationId group by Don.DonorId) MaxDon on Don.DonorId = MaxDon.DonorId and Don.DonationDate = MaxDon.MaxDate join DonationTestResults DonTest on Don.UniqueId = DonTest.DonationId where DonTest.TestTypeId = 42 and DonTest.TestValue = 13) and PerC.Gender in (1, 2) and PerC.IdentityDocId is not null and ((PerC.RegAddressId is not null and PerC.RegAddressIsInactive = 0) or (PerC.FactAddressId is not null and PerC.FactAddressIsInactive = 0) or (PerC.TempAddressId is not null and PerC.TempAddressIsInactive = 0)) and DonTP.IsActive = 1 and DonT.DonationParams not in (4, 5, 6, 7, 12, 15) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType = 2) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType in (3, 4) and MedTT.BloodTestCategory != 10) and DonT.ChargeType not in (0, 3) and DonT.ComponentType in (3, 4, 5)",11
"select top(1) PerC.UniqueId Ent, 'Нарушен максимальный объем взятой плазмы за год.' OR1 from ref.SystemSettings SysSet, PersonCards PerC join (select Don.DonorId, sum(Prod.Volume) Q from Donations Don join ref.DonationTypes DonT on Don.DonationTypeId = DonT.UniqueId join ProductComponents Prod on Don.UniqueId = Prod.DonationId where DonT.ComponentType = 2 and Don.IsDeleted = 0 and Don.UniqueId not in (select DonCom.DonationId from DonationComplications DonCom join ref.DonationComplicationTypes DonComT on DonCom.ComplicationTypeGuid = DonComT.Guid where DonComT.CalculateDonation = 0) and cast(Don.DonationDate as date) > dateadd(year, -1, cast(getdate() as date)) group by Don.DonorId) Com on PerC.UniqueId = Com.DonorId join AppointedDonationTypes AppD on PerC.UniqueId = AppD.DonorId join (select AppD.DonorId, max(AppD.DonationDate) MaxDate from AppointedDonationTypes AppD group by AppD.DonorId) Main on AppD.DonorId = Main.DonorId and AppD.DonationDate = Main.MaxDate join ref.DonationTypeParams DonTP on AppD.DonationTypeId = DonTP.DonationTypeId join ref.DonationTypes DonT on AppD.DonationTypeId = DonT.UniqueId where PerC.IsDeleted != 1 and Com.Q + DonTP.StdDose > SysSet.MaxYearPlasmaVolumeFemale * 1000 and PerC.BirthDateIsUndefined = 0 and PerC.DeathDate is null and PerC.UniqueId in (select AppD.DonorId from AppointedDonationTypes AppD) and PerC.UniqueId not in (select PrReg.DonorId from DonationProcessRegistry PrReg where PrReg.RegDate = cast(getdate() as date)) and PerC.UniqueId not in (select Don.DonorId from Donations Don where cast(Don.DonationDate as date) = cast(getdate() as date)) and PerC.UniqueId not in (select PerC.UniqueId from PersonCards PerC join Deferrals Def on Perc.UniqueId = Def.DonorId join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where DefT.BaseType = 1 and Def.RevokeDate is null) and PerC.UniqueId not in (select MaxDon.DonorId from Donations Don join (select Don.DonorId, max(Don.DonationDate) MaxDate from Donations Don, ref.SystemSettings SysSet where Don.OrgId = SysSet.CurrentOrganizationId group by Don.DonorId) MaxDon on Don.DonorId = MaxDon.DonorId and Don.DonationDate = MaxDon.MaxDate join DonationTestResults DonTest on Don.UniqueId = DonTest.DonationId where DonTest.TestTypeId = 42 and DonTest.TestValue = 13) and PerC.Gender = 2 and PerC.IdentityDocId is not null and ((PerC.RegAddressId is not null and PerC.RegAddressIsInactive = 0) or (PerC.FactAddressId is not null and PerC.FactAddressIsInactive = 0) or (PerC.TempAddressId is not null and PerC.TempAddressIsInactive = 0)) and DonTP.IsActive = 1 and DonT.DonationParams not in (4, 5, 6, 7, 12, 15) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType = 2) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType in (3, 4) and MedTT.BloodTestCategory != 10) and DonT.ChargeType not in (0, 3) and DonT.ComponentType = 2",12
"select top(1) PerC.UniqueId Ent, 'Нарушен максимальный объем взятой плазмы за год.' OR1 from ref.SystemSettings SysSet, PersonCards PerC join (select Don.DonorId, sum(Prod.Volume) Q from Donations Don join ref.DonationTypes DonT on Don.DonationTypeId = DonT.UniqueId join ProductComponents Prod on Don.UniqueId = Prod.DonationId where DonT.ComponentType = 2 and Don.IsDeleted = 0 and Don.UniqueId not in (select DonCom.DonationId from DonationComplications DonCom join ref.DonationComplicationTypes DonComT on DonCom.ComplicationTypeGuid = DonComT.Guid where DonComT.CalculateDonation = 0) and cast(Don.DonationDate as date) > dateadd(year, -1, cast(getdate() as date)) group by Don.DonorId) Com on PerC.UniqueId = Com.DonorId join AppointedDonationTypes AppD on PerC.UniqueId = AppD.DonorId join (select AppD.DonorId, max(AppD.DonationDate) MaxDate from AppointedDonationTypes AppD group by AppD.DonorId) Main on AppD.DonorId = Main.DonorId and AppD.DonationDate = Main.MaxDate join ref.DonationTypeParams DonTP on AppD.DonationTypeId = DonTP.DonationTypeId join ref.DonationTypes DonT on AppD.DonationTypeId = DonT.UniqueId where PerC.IsDeleted != 1 and Com.Q + DonTP.StdDose > SysSet.MaxYearPlasmaVolumeMale * 1000 and PerC.BirthDateIsUndefined = 0 and PerC.DeathDate is null and PerC.UniqueId in (select AppD.DonorId from AppointedDonationTypes AppD) and PerC.UniqueId not in (select PrReg.DonorId from DonationProcessRegistry PrReg where PrReg.RegDate = cast(getdate() as date)) and PerC.UniqueId not in (select Don.DonorId from Donations Don where cast(Don.DonationDate as date) = cast(getdate() as date)) and PerC.UniqueId not in (select PerC.UniqueId from PersonCards PerC join Deferrals Def on Perc.UniqueId = Def.DonorId join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where DefT.BaseType = 1 and Def.RevokeDate is null) and PerC.UniqueId not in (select MaxDon.DonorId from Donations Don join (select Don.DonorId, max(Don.DonationDate) MaxDate from Donations Don, ref.SystemSettings SysSet where Don.OrgId = SysSet.CurrentOrganizationId group by Don.DonorId) MaxDon on Don.DonorId = MaxDon.DonorId and Don.DonationDate = MaxDon.MaxDate join DonationTestResults DonTest on Don.UniqueId = DonTest.DonationId where DonTest.TestTypeId = 42 and DonTest.TestValue = 13) and PerC.Gender = 1 and PerC.IdentityDocId is not null and ((PerC.RegAddressId is not null and PerC.RegAddressIsInactive = 0) or (PerC.FactAddressId is not null and PerC.FactAddressIsInactive = 0) or (PerC.TempAddressId is not null and PerC.TempAddressIsInactive = 0)) and DonTP.IsActive = 1 and DonT.DonationParams not in (4, 5, 6, 7, 12, 15) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType = 2) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType in (3, 4) and MedTT.BloodTestCategory != 10) and DonT.ChargeType not in (0, 3) and DonT.ComponentType = 2",13
"select top(1) PerC.UniqueId Ent, 'Возраст донора не соответствует настройкам системы: до ' + cast(SysSet.DonorMaxAge as nvarchar) OR1 from ref.SystemSettings SysSet, PersonCards PerC join AppointedDonationTypes AppD on PerC.UniqueId = AppD.DonorId join (select AppD.DonorId, max(AppD.DonationDate) MaxDate from AppointedDonationTypes AppD group by AppD.DonorId) Main on AppD.DonorId = Main.DonorId and AppD.DonationDate = Main.MaxDate join ref.DonationTypeParams DonTP on AppD.DonationTypeId = DonTP.DonationTypeId join ref.DonationTypes DonT on AppD.DonationTypeId = DonT.UniqueId where PerC.IsDeleted != 1 and cast(PerC.BirthDate as date) < cast(dateadd(year, -SysSet.DonorMaxAge, getdate()) as date) and PerC.BirthDateIsUndefined = 0 and PerC.DeathDate is null and PerC.UniqueId in (select AppD.DonorId from AppointedDonationTypes AppD) and PerC.UniqueId not in (select PrReg.DonorId from DonationProcessRegistry PrReg where PrReg.RegDate = cast(getdate() as date)) and PerC.UniqueId not in (select Don.DonorId from Donations Don where cast(Don.DonationDate as date) = cast(getdate() as date)) and PerC.UniqueId not in (select PerC.UniqueId from PersonCards PerC join Deferrals Def on Perc.UniqueId = Def.DonorId join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where DefT.BaseType = 1 and Def.RevokeDate is null) and PerC.UniqueId not in (select MaxDon.DonorId from Donations Don join (select Don.DonorId, max(Don.DonationDate) MaxDate from Donations Don, ref.SystemSettings SysSet where Don.OrgId = SysSet.CurrentOrganizationId group by Don.DonorId) MaxDon on Don.DonorId = MaxDon.DonorId and Don.DonationDate = MaxDon.MaxDate join DonationTestResults DonTest on Don.UniqueId = DonTest.DonationId where DonTest.TestTypeId = 42 and DonTest.TestValue = 13) and PerC.Gender in (1,2) and PerC.IdentityDocId is not null and ((PerC.RegAddressId is not null and PerC.RegAddressIsInactive = 0) or (PerC.FactAddressId is not null and PerC.FactAddressIsInactive = 0) or (PerC.TempAddressId is not null and PerC.TempAddressIsInactive = 0)) and DonTP.IsActive = 1 and DonT.DonationParams not in (4, 5, 6, 7, 12, 15) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType = 2) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType in (3, 4) and MedTT.BloodTestCategory != 10) and DonT.ChargeType not in (0, 3)",14
"select top(1) PerC.UniqueId Ent, 'Возраст донора не соответствует настройкам системы: от ' + cast(SysSet.DonorMinAge as nvarchar) OR1 from ref.SystemSettings SysSet, PersonCards PerC join AppointedDonationTypes AppD on PerC.UniqueId = AppD.DonorId join (select AppD.DonorId, max(AppD.DonationDate) MaxDate from AppointedDonationTypes AppD group by AppD.DonorId) Main on AppD.DonorId = Main.DonorId and AppD.DonationDate = Main.MaxDate join ref.DonationTypeParams DonTP on AppD.DonationTypeId = DonTP.DonationTypeId join ref.DonationTypes DonT on AppD.DonationTypeId = DonT.UniqueId where PerC.IsDeleted != 1 and cast(PerC.BirthDate as date) > cast(dateadd(year, -SysSet.DonorMinAge, getdate()) as date) and PerC.BirthDateIsUndefined = 0 and PerC.DeathDate is null and PerC.UniqueId in (select AppD.DonorId from AppointedDonationTypes AppD) and PerC.UniqueId not in (select PrReg.DonorId from DonationProcessRegistry PrReg where PrReg.RegDate = cast(getdate() as date)) and PerC.UniqueId not in (select Don.DonorId from Donations Don where cast(Don.DonationDate as date) = cast(getdate() as date)) and PerC.UniqueId not in (select PerC.UniqueId from PersonCards PerC join Deferrals Def on Perc.UniqueId = Def.DonorId join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where DefT.BaseType = 1 and Def.RevokeDate is null) and PerC.UniqueId not in (select MaxDon.DonorId from Donations Don join (select Don.DonorId, max(Don.DonationDate) MaxDate from Donations Don, ref.SystemSettings SysSet where Don.OrgId = SysSet.CurrentOrganizationId group by Don.DonorId) MaxDon on Don.DonorId = MaxDon.DonorId and Don.DonationDate = MaxDon.MaxDate join DonationTestResults DonTest on Don.UniqueId = DonTest.DonationId where DonTest.TestTypeId = 42 and DonTest.TestValue = 13) and PerC.Gender in (1,2) and PerC.IdentityDocId is not null and ((PerC.RegAddressId is not null and PerC.RegAddressIsInactive = 0) or (PerC.FactAddressId is not null and PerC.FactAddressIsInactive = 0) or (PerC.TempAddressId is not null and PerC.TempAddressIsInactive = 0)) and DonTP.IsActive = 1 and DonT.DonationParams not in (4, 5, 6, 7, 12, 15) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType = 2) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType in (3, 4) and MedTT.BloodTestCategory != 10) and DonT.ChargeType not in (0, 3)",15
"select top(1) PerC.UniqueId Ent, 'В журнале эпидконтроля найден адрес донора (Регистрации: Проживает)' OR1, cast(getdate() as date), dateadd(day, DefTP.EpidControlPeriod, cast(Def.StartDate as date)) from PersonCards PerC join EpidControls Epid on PerC.RegAddressId = Epid.PersonAddressId join Deferrals Def on Epid.DeferralId = Def.UniqueId join ref.DeferralTypeParams DefTP on Def.DeferralTypeId = DefTP.DeferralTypeId join AppointedDonationTypes AppD on PerC.UniqueId = AppD.DonorId join (select AppD.DonorId, max(AppD.DonationDate) MaxDate from AppointedDonationTypes AppD group by AppD.DonorId) Main on AppD.DonorId = Main.DonorId and AppD.DonationDate = Main.MaxDate join ref.DonationTypeParams DonTP on AppD.DonationTypeId = DonTP.DonationTypeId join ref.DonationTypes DonT on AppD.DonationTypeId = DonT.UniqueId where PerC.IsDeleted != 1 and cast(dateadd(day, DefTP.EpidControlPeriod, Def.StartDate) as date) > cast(getdate() as date) and DefTP.EpidControlPeriod != 0 and PerC.BirthDateIsUndefined = 0 and PerC.DeathDate is null and PerC.Gender in (1,2) and PerC.IdentityDocId is not null and PerC.UniqueId not in (select PrReg.DonorId from DonationProcessRegistry PrReg where PrReg.RegDate = cast(getdate() as date)) and PerC.UniqueId not in (select Don.DonorId from Donations Don where cast(Don.DonationDate as date) = cast(getdate() as date)) and PerC.UniqueId not in (select PerC.UniqueId from PersonCards PerC join Deferrals Def on Perc.UniqueId = Def.DonorId join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where DefT.BaseType = 1 and Def.RevokeDate is null) and PerC.UniqueId not in (select MaxDon.DonorId from Donations Don join (select Don.DonorId, max(Don.DonationDate) MaxDate from Donations Don, ref.SystemSettings SysSet where Don.OrgId = SysSet.CurrentOrganizationId group by Don.DonorId) MaxDon on Don.DonorId = MaxDon.DonorId and Don.DonationDate = MaxDon.MaxDate join DonationTestResults DonTest on Don.UniqueId = DonTest.DonationId where DonTest.TestTypeId = 42 and DonTest.TestValue = 13) and Perc.RegAddressIsInactive = 0 and Def.RevokeDate is null and DonTP.IsActive = 1 and DonT.DonationParams not in (4, 5, 6, 7, 12, 15) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and (MedTT.ExamType = 2 or (MedTT.ExamType in (3, 4) and MedTT.BloodTestCategory != 10))) and DonT.ChargeType not in (0, 3)",16
"select top(1) PerC.UniqueId Ent, 'В журнале эпидконтроля найден адрес донора (Проживания: Проживает).' OR1, cast(getdate() as date), dateadd(day, DefTP.EpidControlPeriod, cast(Def.StartDate as date)) from PersonCards PerC join EpidControls Epid on PerC.FactAddressId = Epid.PersonAddressId join Deferrals Def on Epid.DeferralId = Def.UniqueId join ref.DeferralTypeParams DefTP on Def.DeferralTypeId = DefTP.DeferralTypeId join AppointedDonationTypes AppD on PerC.UniqueId = AppD.DonorId join (select AppD.DonorId, max(AppD.DonationDate) MaxDate from AppointedDonationTypes AppD group by AppD.DonorId) Main on AppD.DonorId = Main.DonorId and AppD.DonationDate = Main.MaxDate join ref.DonationTypeParams DonTP on AppD.DonationTypeId = DonTP.DonationTypeId join ref.DonationTypes DonT on AppD.DonationTypeId = DonT.UniqueId where PerC.IsDeleted != 1 and cast(dateadd(day, DefTP.EpidControlPeriod, Def.StartDate) as date) > cast(getdate() as date) and DefTP.EpidControlPeriod != 0 and PerC.BirthDateIsUndefined = 0 and PerC.DeathDate is null and PerC.Gender in (1,2) and PerC.IdentityDocId is not null and PerC.UniqueId not in (select PrReg.DonorId from DonationProcessRegistry PrReg where PrReg.RegDate = cast(getdate() as date)) and PerC.UniqueId not in (select Don.DonorId from Donations Don where cast(Don.DonationDate as date) = cast(getdate() as date)) and PerC.UniqueId not in (select PerC.UniqueId from PersonCards PerC join Deferrals Def on Perc.UniqueId = Def.DonorId join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where DefT.BaseType = 1 and Def.RevokeDate is null) and PerC.UniqueId not in (select MaxDon.DonorId from Donations Don join (select Don.DonorId, max(Don.DonationDate) MaxDate from Donations Don, ref.SystemSettings SysSet where Don.OrgId = SysSet.CurrentOrganizationId group by Don.DonorId) MaxDon on Don.DonorId = MaxDon.DonorId and Don.DonationDate = MaxDon.MaxDate join DonationTestResults DonTest on Don.UniqueId = DonTest.DonationId where DonTest.TestTypeId = 42 and DonTest.TestValue = 13) and PerC.FactAddressIsInactive = 0 and (PerC.FactAddressId != PerC.RegAddressId or PerC.RegAddressId is null) and (PerC.FactAddressId != PerC.TempAddressId or PerC.TempAddressId is null) and Def.RevokeDate is null and DonTP.IsActive = 1 and DonT.DonationParams not in (4, 5, 6, 7, 12, 15) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and (MedTT.ExamType = 2 or (MedTT.ExamType in (3, 4) and MedTT.BloodTestCategory != 10))) and DonT.ChargeType not in (0, 3)",17
"select top(1) PerC.UniqueId Ent, 'В журнале эпидконтроля найден адрес донора (Временной: Не проживает)' OR1 from PersonCards PerC join EpidControls Epid on PerC.TempAddressId = Epid.PersonAddressId join Deferrals Def on Epid.DeferralId = Def.UniqueId join ref.DeferralTypeParams DefTP on Def.DeferralTypeId = DefTP.DeferralTypeId join AppointedDonationTypes AppD on PerC.UniqueId = AppD.DonorId join (select AppD.DonorId, max(AppD.DonationDate) MaxDate from AppointedDonationTypes AppD group by AppD.DonorId) Main on AppD.DonorId = Main.DonorId and AppD.DonationDate = Main.MaxDate join ref.DonationTypeParams DonTP on AppD.DonationTypeId = DonTP.DonationTypeId join ref.DonationTypes DonT on AppD.DonationTypeId = DonT.UniqueId where PerC.IsDeleted != 1 and DefTP.EpidControlPeriod != 0 and PerC.BirthDateIsUndefined = 0 and PerC.DeathDate is null and PerC.Gender in (1,2) and PerC.IdentityDocId is not null and PerC.UniqueId not in (select PrReg.DonorId from DonationProcessRegistry PrReg where PrReg.RegDate = cast(getdate() as date)) and PerC.UniqueId not in (select Don.DonorId from Donations Don where cast(Don.DonationDate as date) = cast(getdate() as date)) and PerC.UniqueId not in (select PerC.UniqueId from PersonCards PerC join Deferrals Def on Perc.UniqueId = Def.DonorId join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where DefT.BaseType = 1 and Def.RevokeDate is null) and PerC.UniqueId not in (select MaxDon.DonorId from Donations Don join (select Don.DonorId, max(Don.DonationDate) MaxDate from Donations Don, ref.SystemSettings SysSet where Don.OrgId = SysSet.CurrentOrganizationId group by Don.DonorId) MaxDon on Don.DonorId = MaxDon.DonorId and Don.DonationDate = MaxDon.MaxDate join DonationTestResults DonTest on Don.UniqueId = DonTest.DonationId where DonTest.TestTypeId = 42 and DonTest.TestValue = 13) and PerC.TempAddressIsInactive = 1 and Def.RevokeDate is null and DonTP.IsActive = 1 and ((PerC.RegAddressId is not null and PerC.RegAddressIsInactive = 0) or (PerC.FactAddressId is not null and PerC.FactAddressIsInactive = 0)) and DonT.DonationParams not in (4, 5, 6, 7, 12, 15) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and (MedTT.ExamType = 2 or (MedTT.ExamType in (3, 4) and MedTT.BloodTestCategory != 10))) and DonT.ChargeType not in (0, 3)",18
"select top(1) PerC.UniqueId Ent, 'Адрес донора заполнен не в формате ФИАС (может вызвать проблемы при определении ЭК).' OR1 from PersonCards PerC join AppointedDonationTypes AppD on PerC.UniqueId = AppD.DonorId join (select AppD.DonorId, max(AppD.DonationDate) MaxDate from AppointedDonationTypes AppD group by AppD.DonorId) Main on AppD.DonorId = Main.DonorId and AppD.DonationDate = Main.MaxDate join ref.DonationTypeParams DonTP on AppD.DonationTypeId = DonTP.DonationTypeId join ref.DonationTypes DonT on AppD.DonationTypeId = DonT.UniqueId join PersonAddresses PerAdd on PerC.RegAddressId = PerAdd.UniqueId left join PersonAddresses PerFact on PerC.FactAddressId = PerFact.UniqueId left join PersonAddresses PerTemp on PerC.RegAddressId = PerTemp.UniqueId where PerC.IsDeleted != 1 and PerC.BirthDateIsUndefined = 0 and PerC.DeathDate is null and PerC.UniqueId in (select AppD.DonorId from AppointedDonationTypes AppD) and PerC.UniqueId not in (select PrReg.DonorId from DonationProcessRegistry PrReg where PrReg.RegDate = cast(getdate() as date)) and PerC.UniqueId not in (select Don.DonorId from Donations Don where cast(Don.DonationDate as date) = cast(getdate() as date)) and PerC.UniqueId not in (select PerC.UniqueId from PersonCards PerC join Deferrals Def on Perc.UniqueId = Def.DonorId join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where DefT.BaseType = 1 and Def.RevokeDate is null) and PerC.UniqueId not in (select MaxDon.DonorId from Donations Don join (select Don.DonorId, max(Don.DonationDate) MaxDate from Donations Don, ref.SystemSettings SysSet where Don.OrgId = SysSet.CurrentOrganizationId group by Don.DonorId) MaxDon on Don.DonorId = MaxDon.DonorId and Don.DonationDate = MaxDon.MaxDate join DonationTestResults DonTest on Don.UniqueId = DonTest.DonationId where DonTest.TestTypeId = 42 and DonTest.TestValue = 13) and PerC.Gender in (1,2) and PerC.IdentityDocId is not null and ((PerC.RegAddressId is not null and PerC.RegAddressIsInactive = 0) or (PerC.FactAddressId is not null and PerC.FactAddressIsInactive = 0) or (PerC.TempAddressId is not null and PerC.TempAddressIsInactive = 0)) and DonTP.IsActive = 1 and DonT.DonationParams not in (4, 5, 6, 7, 12, 15) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType = 2) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType in (3, 4) and MedTT.BloodTestCategory != 10) and DonT.ChargeType not in (0, 3) and PerAdd.FiasRegion is null and PerC.RegAddressIsInactive = 0 and (PerC.FactAddressId is null or PerC.FactAddressIsInactive = 1 or PerFact.FiasRegion is not null) and (PerC.TempAddressId is null or PerC.TempAddressIsInactive = 1 or PerTemp.FiasRegion is not null)",19
"select top(1) PerC.UniqueId Ent, 'Адрес донора заполнен не в формате ФИАС (может вызвать проблемы при определении ЭК).' OR1 from PersonCards PerC join AppointedDonationTypes AppD on PerC.UniqueId = AppD.DonorId join (select AppD.DonorId, max(AppD.DonationDate) MaxDate from AppointedDonationTypes AppD group by AppD.DonorId) Main on AppD.DonorId = Main.DonorId and AppD.DonationDate = Main.MaxDate join ref.DonationTypeParams DonTP on AppD.DonationTypeId = DonTP.DonationTypeId join ref.DonationTypes DonT on AppD.DonationTypeId = DonT.UniqueId join PersonAddresses PerAdd on PerC.FactAddressId = PerAdd.UniqueId left join PersonAddresses PerReg on PerC.RegAddressId = PerReg.UniqueId left join PersonAddresses PerTemp on PerC.FactAddressId = PerTemp.UniqueId where PerC.IsDeleted != 1 and PerC.BirthDateIsUndefined = 0 and PerC.DeathDate is null and PerC.UniqueId in (select AppD.DonorId from AppointedDonationTypes AppD) and PerC.UniqueId not in (select PrReg.DonorId from DonationProcessRegistry PrReg where PrReg.RegDate = cast(getdate() as date)) and PerC.UniqueId not in (select Don.DonorId from Donations Don where cast(Don.DonationDate as date) = cast(getdate() as date)) and PerC.UniqueId not in (select PerC.UniqueId from PersonCards PerC join Deferrals Def on Perc.UniqueId = Def.DonorId join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where DefT.BaseType = 1 and Def.RevokeDate is null) and PerC.UniqueId not in (select MaxDon.DonorId from Donations Don join (select Don.DonorId, max(Don.DonationDate) MaxDate from Donations Don, ref.SystemSettings SysSet where Don.OrgId = SysSet.CurrentOrganizationId group by Don.DonorId) MaxDon on Don.DonorId = MaxDon.DonorId and Don.DonationDate = MaxDon.MaxDate join DonationTestResults DonTest on Don.UniqueId = DonTest.DonationId where DonTest.TestTypeId = 42 and DonTest.TestValue = 13) and PerC.Gender in (1,2) and PerC.IdentityDocId is not null and ((PerC.RegAddressId is not null and PerC.RegAddressIsInactive = 0) or (PerC.FactAddressId is not null and PerC.FactAddressIsInactive = 0) or (PerC.TempAddressId is not null and PerC.TempAddressIsInactive = 0)) and DonTP.IsActive = 1 and DonT.DonationParams not in (4, 5, 6, 7, 12, 15) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType = 2) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType in (3, 4) and MedTT.BloodTestCategory != 10) and DonT.ChargeType not in (0, 3) and PerAdd.FiasRegion is null and PerC.FactAddressIsInactive = 0 and (PerC.RegAddressId is null or PerC.RegAddressIsInactive = 1 or PerReg.FiasRegion is not null) and (PerC.TempAddressId is null or PerC.TempAddressIsInactive = 1 or PerTemp.FiasRegion is not null)",20
"select top(1) PerC.UniqueId Ent, 'Адрес донора заполнен не в формате ФИАС (может вызвать проблемы при определении ЭК).' OR1 from PersonCards PerC join AppointedDonationTypes AppD on PerC.UniqueId = AppD.DonorId join (select AppD.DonorId, max(AppD.DonationDate) MaxDate from AppointedDonationTypes AppD group by AppD.DonorId) Main on AppD.DonorId = Main.DonorId and AppD.DonationDate = Main.MaxDate join ref.DonationTypeParams DonTP on AppD.DonationTypeId = DonTP.DonationTypeId join ref.DonationTypes DonT on AppD.DonationTypeId = DonT.UniqueId join PersonAddresses PerAdd on PerC.TempAddressId = PerAdd.UniqueId left join PersonAddresses PerReg on PerC.RegAddressId = PerReg.UniqueId left join PersonAddresses PerFact on PerC.FactAddressId = PerFact.UniqueId where PerC.IsDeleted != 1 and PerC.BirthDateIsUndefined = 0 and PerC.DeathDate is null and PerC.UniqueId in (select AppD.DonorId from AppointedDonationTypes AppD) and PerC.UniqueId not in (select PrReg.DonorId from DonationProcessRegistry PrReg where PrReg.RegDate = cast(getdate() as date)) and PerC.UniqueId not in (select Don.DonorId from Donations Don where cast(Don.DonationDate as date) = cast(getdate() as date)) and PerC.UniqueId not in (select PerC.UniqueId from PersonCards PerC join Deferrals Def on Perc.UniqueId = Def.DonorId join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where DefT.BaseType = 1 and Def.RevokeDate is null) and PerC.UniqueId not in (select MaxDon.DonorId from Donations Don join (select Don.DonorId, max(Don.DonationDate) MaxDate from Donations Don, ref.SystemSettings SysSet where Don.OrgId = SysSet.CurrentOrganizationId group by Don.DonorId) MaxDon on Don.DonorId = MaxDon.DonorId and Don.DonationDate = MaxDon.MaxDate join DonationTestResults DonTest on Don.UniqueId = DonTest.DonationId where DonTest.TestTypeId = 42 and DonTest.TestValue = 13) and PerC.Gender in (1,2) and PerC.IdentityDocId is not null and ((PerC.RegAddressId is not null and PerC.RegAddressIsInactive = 0) or (PerC.FactAddressId is not null and PerC.FactAddressIsInactive = 0) or (PerC.TempAddressId is not null and PerC.TempAddressIsInactive = 0)) and DonTP.IsActive = 1 and DonT.DonationParams not in (4, 5, 6, 7, 12, 15) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType = 2) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType in (3, 4) and MedTT.BloodTestCategory != 10) and DonT.ChargeType not in (0, 3) and PerAdd.FiasRegion is null and PerC.TempAddressIsInactive = 0 and (PerC.RegAddressId is null or PerC.RegAddressIsInactive = 1 or PerReg.FiasRegion is not null) and (PerC.FactAddressId is null or PerC.FactAddressIsInactive = 1 or PerFact.FiasRegion is not null)",21
"select top(1) PerC.UniqueId Ent, 'Есть донации с незавершенными анализами.' OR1 from PersonCards PerC join AppointedDonationTypes AppD on PerC.UniqueId = AppD.DonorId join (select AppD.DonorId, max(AppD.DonationDate) MaxDate from AppointedDonationTypes AppD group by AppD.DonorId) Main on AppD.DonorId = Main.DonorId and AppD.DonationDate = Main.MaxDate join ref.DonationTypeParams DonTP on AppD.DonationTypeId = DonTP.DonationTypeId join ref.DonationTypes DonT on AppD.DonationTypeId = DonT.UniqueId join Donations Don on PerC.UniqueId = Don.DonorId join DonationTestResults DonTest on Don.UniqueId = DonTest.DonationId where PerC.IsDeleted != 1 and PerC.BirthDateIsUndefined = 0 and PerC.DeathDate is null and PerC.UniqueId in (select AppD.DonorId from AppointedDonationTypes AppD) and PerC.UniqueId not in (select PrReg.DonorId from DonationProcessRegistry PrReg where PrReg.RegDate = cast(getdate() as date)) and PerC.UniqueId not in (select Don.DonorId from Donations Don where cast(Don.DonationDate as date) = cast(getdate() as date)) and PerC.UniqueId not in (select PerC.UniqueId from PersonCards PerC join Deferrals Def on Perc.UniqueId = Def.DonorId join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where DefT.BaseType = 1 and Def.RevokeDate is null) and PerC.UniqueId not in (select MaxDon.DonorId from Donations Don join (select Don.DonorId, max(Don.DonationDate) MaxDate from Donations Don, ref.SystemSettings SysSet where Don.OrgId = SysSet.CurrentOrganizationId group by Don.DonorId) MaxDon on Don.DonorId = MaxDon.DonorId and Don.DonationDate = MaxDon.MaxDate join DonationTestResults DonTest on Don.UniqueId = DonTest.DonationId where DonTest.TestTypeId = 42 and DonTest.TestValue = 13) and PerC.Gender in (1,2) and PerC.IdentityDocId is not null and ((PerC.RegAddressId is not null and PerC.RegAddressIsInactive = 0) or (PerC.FactAddressId is not null and PerC.FactAddressIsInactive = 0) or (PerC.TempAddressId is not null and PerC.TempAddressIsInactive = 0)) and DonTP.IsActive = 1 and DonT.DonationParams not in (4, 5, 6, 7, 12, 15) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType = 2) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType in (3, 4) and MedTT.BloodTestCategory != 10) and DonT.ChargeType not in (0, 3) and DonTest.IsDone = 0",22
"select top(1) PerC.UniqueId Ent, 'У донора есть важные комментарии:\nОт ' + convert(varchar, Nt.CreateDate, 104)  + ' ' + convert(char(5), Nt.CreateDate, 108) + ': ' + Nt.Text OR1 from PersonCards PerC join AppointedDonationTypes AppD on PerC.UniqueId = AppD.DonorId join (select AppD.DonorId, max(AppD.DonationDate) MaxDate from AppointedDonationTypes AppD group by AppD.DonorId) Main on AppD.DonorId = Main.DonorId and AppD.DonationDate = Main.MaxDate join ref.DonationTypeParams DonTP on AppD.DonationTypeId = DonTP.DonationTypeId join ref.DonationTypes DonT on AppD.DonationTypeId = DonT.UniqueId join PersonMedicalNotes Nt on PerC.UniqueId = Nt.DonorId where PerC.IsDeleted != 1 and PerC.BirthDateIsUndefined = 0 and PerC.DeathDate is null and PerC.UniqueId in (select AppD.DonorId from AppointedDonationTypes AppD) and PerC.UniqueId not in (select PrReg.DonorId from DonationProcessRegistry PrReg where PrReg.RegDate = cast(getdate() as date)) and PerC.UniqueId not in (select Don.DonorId from Donations Don where cast(Don.DonationDate as date) = cast(getdate() as date)) and PerC.UniqueId not in (select PerC.UniqueId from PersonCards PerC join Deferrals Def on Perc.UniqueId = Def.DonorId join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where DefT.BaseType = 1 and Def.RevokeDate is null) and PerC.UniqueId not in (select MaxDon.DonorId from Donations Don join (select Don.DonorId, max(Don.DonationDate) MaxDate from Donations Don, ref.SystemSettings SysSet where Don.OrgId = SysSet.CurrentOrganizationId group by Don.DonorId) MaxDon on Don.DonorId = MaxDon.DonorId and Don.DonationDate = MaxDon.MaxDate join DonationTestResults DonTest on Don.UniqueId = DonTest.DonationId where DonTest.TestTypeId = 42 and DonTest.TestValue = 13) and PerC.Gender in (1,2) and PerC.IdentityDocId is not null and ((PerC.RegAddressId is not null and PerC.RegAddressIsInactive = 0) or (PerC.FactAddressId is not null and PerC.FactAddressIsInactive = 0) or (PerC.TempAddressId is not null and PerC.TempAddressIsInactive = 0)) and DonTP.IsActive = 1 and DonT.DonationParams not in (4, 5, 6, 7, 12, 15) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType = 2) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType in (3, 4) and MedTT.BloodTestCategory != 10) and DonT.ChargeType not in (0, 3) and Nt.AssignedTo in (1, 3, 5, 7, 17, 19, 32, 23) and Nt.IsFixed != 1 and cast(Nt.CreateDate as date) = cast(getdate() as date) and Nt.IsDeleted != 1",23
"select top(1) PerC.UniqueId Ent, 'У донора есть важные комментарии: От ' + convert(varchar, Nt.CreateDate, 104)  + ' ' + convert(char(5), Nt.CreateDate, 108) + ': ' + Nt.Text OR1 from PersonCards PerC join AppointedDonationTypes AppD on PerC.UniqueId = AppD.DonorId join (select AppD.DonorId, max(AppD.DonationDate) MaxDate from AppointedDonationTypes AppD group by AppD.DonorId) Main on AppD.DonorId = Main.DonorId and AppD.DonationDate = Main.MaxDate join ref.DonationTypeParams DonTP on AppD.DonationTypeId = DonTP.DonationTypeId join ref.DonationTypes DonT on AppD.DonationTypeId = DonT.UniqueId join PersonMedicalNotes Nt on PerC.UniqueId = Nt.DonorId where PerC.IsDeleted != 1 and PerC.BirthDateIsUndefined = 0 and PerC.DeathDate is null and PerC.UniqueId in (select AppD.DonorId from AppointedDonationTypes AppD) and PerC.UniqueId not in (select PrReg.DonorId from DonationProcessRegistry PrReg where PrReg.RegDate = cast(getdate() as date)) and PerC.UniqueId not in (select Don.DonorId from Donations Don where cast(Don.DonationDate as date) = cast(getdate() as date)) and PerC.UniqueId not in (select PerC.UniqueId from PersonCards PerC join Deferrals Def on Perc.UniqueId = Def.DonorId join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where DefT.BaseType = 1 and Def.RevokeDate is null) and PerC.UniqueId not in (select MaxDon.DonorId from Donations Don join (select Don.DonorId, max(Don.DonationDate) MaxDate from Donations Don, ref.SystemSettings SysSet where Don.OrgId = SysSet.CurrentOrganizationId group by Don.DonorId) MaxDon on Don.DonorId = MaxDon.DonorId and Don.DonationDate = MaxDon.MaxDate join DonationTestResults DonTest on Don.UniqueId = DonTest.DonationId where DonTest.TestTypeId = 42 and DonTest.TestValue = 13) and PerC.Gender in (1,2) and PerC.IdentityDocId is not null and ((PerC.RegAddressId is not null and PerC.RegAddressIsInactive = 0) or (PerC.FactAddressId is not null and PerC.FactAddressIsInactive = 0) or (PerC.TempAddressId is not null and PerC.TempAddressIsInactive = 0)) and DonTP.IsActive = 1 and DonT.DonationParams not in (4, 5, 6, 7, 12, 15) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType = 2) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType in (3, 4) and MedTT.BloodTestCategory != 10) and DonT.ChargeType not in (0, 3) and Nt.AssignedTo in (1, 3, 5, 7, 17, 19, 32, 23) and Nt.IsFixed = 1 and cast(Nt.CreateDate as date) != cast(getdate() as date) and Nt.IsDeleted != 1",24
"select top(1) PerC.UniqueId Ent, 'У донора есть незавершенные донации.' OR1 from PersonCards PerC join AppointedDonationTypes AppD on PerC.UniqueId = AppD.DonorId join (select AppD.DonorId, max(AppD.DonationDate) MaxDate from AppointedDonationTypes AppD group by AppD.DonorId) Main on AppD.DonorId = Main.DonorId and AppD.DonationDate = Main.MaxDate join ref.DonationTypeParams DonTP on AppD.DonationTypeId = DonTP.DonationTypeId join ref.DonationTypes DonT on AppD.DonationTypeId = DonT.UniqueId join Donations Don on PerC.UniqueId = Don.DonorId where PerC.IsDeleted != 1 and PerC.BirthDateIsUndefined = 0 and PerC.DeathDate is null and PerC.UniqueId in (select AppD.DonorId from AppointedDonationTypes AppD) and PerC.UniqueId not in (select PrReg.DonorId from DonationProcessRegistry PrReg where PrReg.RegDate = cast(getdate() as date)) and PerC.UniqueId not in (select Don.DonorId from Donations Don where cast(Don.DonationDate as date) = cast(getdate() as date)) and PerC.UniqueId not in (select PerC.UniqueId from PersonCards PerC join Deferrals Def on Perc.UniqueId = Def.DonorId join ref.DeferralTypes DefT on Def.DeferralTypeId = DefT.UniqueId where DefT.BaseType = 1 and Def.RevokeDate is null) and PerC.UniqueId not in (select MaxDon.DonorId from Donations Don join (select Don.DonorId, max(Don.DonationDate) MaxDate from Donations Don, ref.SystemSettings SysSet where Don.OrgId = SysSet.CurrentOrganizationId group by Don.DonorId) MaxDon on Don.DonorId = MaxDon.DonorId and Don.DonationDate = MaxDon.MaxDate join DonationTestResults DonTest on Don.UniqueId = DonTest.DonationId where DonTest.TestTypeId = 42 and DonTest.TestValue = 13) and PerC.Gender in (1,2) and PerC.IdentityDocId is not null and ((PerC.RegAddressId is not null and PerC.RegAddressIsInactive = 0) or (PerC.FactAddressId is not null and PerC.FactAddressIsInactive = 0) or (PerC.TempAddressId is not null and PerC.TempAddressIsInactive = 0)) and DonTP.IsActive = 1 and DonT.DonationParams not in (4, 5, 6, 7, 12, 15) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType = 2) and DonT.UniqueId in (select DonTest.DonationTypeId from ref.DonationTypeBloodTestTypes DonTest join ref.MedicalTestTypes MedTT on DonTest.BloodTestTypeId = MedTT.Id and MedTT.ExamType in (3, 4) and MedTT.BloodTestCategory != 10) and DonT.ChargeType not in (0, 3) and Don.ResultStatus != 5",25